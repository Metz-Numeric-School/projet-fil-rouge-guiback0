{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - ACCESS MNS MANAGER{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-house-door"></i>
            Tableau de bord
        </li>
    </ol>
</nav>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Tableau de bord</h1>
                    <p class="text-muted">Vue d'ensemble du système ACCESS MNS</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-3 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>{{ total_users }}</h3>
                        <p class="mb-0">Utilisateurs</p>
                        <small class="text-white-50">Total enregistrés</small>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-people fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-3 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>{{ total_organisations }}</h3>
                        <p class="mb-0">Organisations</p>
                        <small class="text-white-50">Actives</small>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-building fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-3 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>{{ total_badges ?? 0 }}</h3>
                        <p class="mb-0">Badges actifs</p>
                        <small class="text-white-50">En circulation</small>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-credit-card fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-3 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>{{ total_zones ?? 0 }}</h3>
                        <p class="mb-0">Zones</p>
                        <small class="text-white-50">Contrôlées</small>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-geo-alt fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row mx-0">
        <!-- Recent Activity -->
        <div class="col-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i>
                        Activité récente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Heure</th>
                                    <th>Type</th>
                                    <th>Utilisateur</th>
                                    <th>Zone</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <small class="text-muted">{{ "now"|date("H:i") }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="bi bi-box-arrow-in-right"></i>
                                            Entrée
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2" style="width: 30px; height: 30px;">
                                                M
                                            </div>
                                            <div>
                                                <div class="fw-medium">Marie Dubois</div>
                                                <small class="text-muted">Développeuse</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Bureau R&D</td>
                                    <td>
                                        <span class="badge badge-status status-active">
                                            <i class="bi bi-check-circle"></i>
                                            Autorisé
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <small class="text-muted">{{ "now"|date_modify("-5 minutes")|date("H:i") }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            Tentative
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2" style="width: 30px; height: 30px;">
                                                J
                                            </div>
                                            <div>
                                                <div class="fw-medium">Jean Martin</div>
                                                <small class="text-muted">Comptable</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Salle serveurs</td>
                                    <td>
                                        <span class="badge badge-status status-inactive">
                                            <i class="bi bi-x-circle"></i>
                                            Refusé
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <small class="text-muted">{{ "now"|date_modify("-12 minutes")|date("H:i") }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            <i class="bi bi-box-arrow-left"></i>
                                            Sortie
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2" style="width: 30px; height: 30px;">
                                                A
                                            </div>
                                            <div>
                                                <div class="fw-medium">Alice Bernard</div>
                                                <small class="text-muted">RH</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Accueil</td>
                                    <td>
                                        <span class="badge badge-status status-active">
                                            <i class="bi bi-check-circle"></i>
                                            Autorisé
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ path('app_pointage_index') }}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-right"></i>
                            Voir tous les pointages
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts & Quick Actions -->
        <div class="col-4 mb-4">
            <!-- System Alerts -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Alertes système
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" role="alert">
                        <strong>
                            <i class="bi bi-wifi-off"></i>
                            Badgeuse hors ligne
                        </strong>
                        <p class="mb-1">Badgeuse "Entrée principale" déconnectée</p>
                        <small class="text-muted">Il y a 15 minutes</small>
                    </div>
                    
                    <div class="alert alert-danger" role="alert">
                        <strong>
                            <i class="bi bi-shield-exclamation"></i>
                            Tentative d'accès suspect
                        </strong>
                        <p class="mb-1">3 tentatives d'accès refusées consécutives</p>
                        <small class="text-muted">Il y a 32 minutes</small>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <strong>
                            <i class="bi bi-calendar-event"></i>
                            Maintenance programmée
                        </strong>
                        <p class="mb-1">Mise à jour système prévue demain 2h-4h</p>
                        <small class="text-muted">Notification</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning"></i>
                        Actions rapides
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_user_new') }}" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i>
                            Nouvel utilisateur
                        </a>
                        <a href="{{ path('app_organisation_new') }}" class="btn btn-secondary">
                            <i class="bi bi-building-add"></i>
                            Nouvelle organisation
                        </a>
                        <a href="{{ path('app_badge_new') }}" class="btn btn-outline-primary">
                            <i class="bi bi-credit-card"></i>
                            Nouveau badge
                        </a>
                        <a href="{{ path('app_zone_new') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-geo-alt"></i>
                            Nouvelle zone
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Organizations -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-building"></i>
                        Organisations récentes
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_organisations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Date de création</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for organisation in recent_organisations %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-3" style="width: 40px; height: 40px; background-color: var(--secondary-color);">
                                                    {% if organisation.nomOrganisation %}
                                                        {{ organisation.nomOrganisation|first|upper }}
                                                    {% else %}
                                                        O
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <div class="fw-medium">{{ organisation.nomOrganisation ?? 'Organisation sans nom' }}</div>
                                                    <small class="text-muted">{{ organisation.email ?? 'Email non renseigné' }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                Entreprise
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ organisation.dateCreation ? organisation.dateCreation|date('d/m/Y') : 'Non renseignée' }}
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge badge-status status-active">
                                                <i class="bi bi-check-circle"></i>
                                                Active
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ path('app_organisation_show', {'id': organisation.id}) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{{ path('app_organisation_edit', {'id': organisation.id}) }}" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-building text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Aucune organisation récente</p>
                            <a href="{{ path('app_organisation_new') }}" class="btn btn-primary">
                                <i class="bi bi-plus"></i>
                                Créer une organisation
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mt-4">
        <div class="col-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart"></i>
                        Accès par jour (7 derniers jours)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="accessChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si Chart.js est chargé
    if (typeof Chart === 'undefined') {
        console.error('Chart.js n\'est pas chargé');
        return;
    }

    // Graphique des accès par jour
    const accessCtx = document.getElementById('accessChart');
    if (accessCtx) {
        const accessChart = new Chart(accessCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                datasets: [{
                    label: 'Accès autorisés',
                    data: [120, 190, 300, 250, 280, 50, 30],
                    borderColor: '#FF5D2D',
                    backgroundColor: 'rgba(255, 93, 45, 0.1)',
                    tension: 0.3
                }, {
                    label: 'Accès refusés',
                    data: [5, 8, 12, 6, 9, 2, 1],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Graphique des zones
    const zoneCtx = document.getElementById('zoneChart');
    if (zoneCtx) {
        const zoneChart = new Chart(zoneCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Bureaux', 'Salles de réunion', 'Accueil', 'Parking', 'Autres'],
                datasets: [{
                    data: [45, 25, 15, 10, 5],
                    backgroundColor: [
                        '#FF5D2D',
                        '#25176E',
                        '#28a745',
                        '#ffc107',
                        '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Auto-refresh data every 30 seconds
    setInterval(function() {
        // Ici vous pouvez ajouter du code pour actualiser les données
        console.log('Actualisation des données...');
        // Exemple : fetchAndUpdateDashboardData();
    }, 30000);
});

// Fonction pour actualiser les données du dashboard via AJAX
function fetchAndUpdateDashboardData() {
    // Cette fonction pourrait être utilisée pour mettre à jour les données sans recharger la page
    // fetch('/api/dashboard/stats')
    //     .then(response => response.json())
    //     .then(data => {
    //         // Mise à jour des statistiques
    //     })
    //     .catch(error => console.error('Erreur lors de l\'actualisation:', error));
}
</script>
{% endblock %}